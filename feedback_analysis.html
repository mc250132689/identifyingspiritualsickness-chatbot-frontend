<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ðŸ“Š Feedback Analysis</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="stylesheet" href="style.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: Arial, sans-serif; background:#f9f9f9; }
  .container { max-width: 1300px; margin:auto; padding:20px; background:#fff; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,0.1);}
  h2,h3 { margin-top:25px; }
  table { width:100%; border-collapse:collapse; margin-top:10px;}
  th, td { border:1px solid #ccc; padding:8px; font-size:14px; text-align:left;}
  th { background:#f0f0f0; }
  .sentiment-positive { color:#16a34a; font-weight:bold; }
  .sentiment-negative { color:#dc2626; font-weight:bold; }
  .sentiment-neutral { color:#444; font-weight:bold; }
  #word-frequency span { display:inline-block; margin:3px; padding:3px 6px; background:#e0f2f1; border-radius:4px; font-size:13px; cursor:pointer; }
  #word-frequency span:hover { background:#16a34a; color:#fff; }
  .btn { padding:8px 16px; border:none; border-radius:6px; background:#16a34a; color:#fff; cursor:pointer; transition:0.2s; margin-right:8px; }
  .btn:hover { background:#138a3a; }
  input, select { padding:6px 10px; margin:5px 0; border-radius:6px; border:1px solid #ccc; font-size:13px; }
  .summary { display:flex; flex-wrap:wrap; gap:15px; margin-bottom:20px; }
  .summary div { flex:1; min-width:150px; background:#f0fdf4; padding:10px; border-radius:8px; text-align:center; }
</style>
</head>
<body>
<div class="container">
  <h2>ðŸ“Š Feedback Analysis</h2>

  <div class="summary">
    <div>Total Submissions: <strong id="total-feedback">0</strong></div>
    <div>Average Usability: <strong id="avg-usability">0</strong></div>
    <div>Average Relevance: <strong id="avg-relevance">0</strong></div>
    <div>Average Accuracy: <strong id="avg-accuracy">0</strong></div>
    <div>Average Helpfulness: <strong id="avg-helpfulness">0</strong></div>
    <div>Average Satisfaction: <strong id="avg-satisfaction">0</strong></div>
  </div>

  <button class="btn" onclick="exportCSV()">Export CSV</button>

  <h3>Ratings Distribution (Q4-Q13)</h3>
  <canvas id="ratingsChart" height="120"></canvas>

  <h3>Sentiment Overview</h3>
  <canvas id="sentimentChart" height="80"></canvas>
  <table>
    <thead><tr><th>Sentiment</th><th>Count</th></tr></thead>
    <tbody id="sentiment-table"></tbody>
  </table>

  <h3>Common Words in Comments</h3>
  <div id="word-frequency"></div>

  <h3>All Feedback</h3>
  <input type="text" id="search" placeholder="Search by name, student ID, program, or comment..." style="width:100%; margin-bottom:10px;">
  <table id="feedback-table">
    <thead>
      <tr>
        <th>#</th><th>Name</th><th>Student ID</th><th>Program</th><th>Ratings (Q4-Q13)</th><th>Comments</th><th>Sentiment</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
const FEEDBACK_URL = "https://identifyingspiritualsickness-chatbot.onrender.com/export-feedback?key=mc250132689";
let feedbackData = [];

async function loadFeedback(){
  try{
    const res = await fetch(FEEDBACK_URL);
    const data = await res.json();
    feedbackData = data.feedback || [];
    document.getElementById("total-feedback").textContent = feedbackData.length;

    let sentimentCount = {Positive:0, Neutral:0, Negative:0};
    let ratingSums = {q4:0,q7:0,q8:0,q10:0,q13:0};
    let ratingCounts = {q4:{},q7:{},q8:{},q10:{},q13:{}};

    const tbody = document.querySelector("#feedback-table tbody");
    tbody.innerHTML = "";

    feedbackData.forEach((f,i)=>{
      const sentiment = classifySentiment(f.q14 || "");
      sentimentCount[sentiment]++;
      
      ["q4","q7","q8","q10","q13"].forEach(q=>{
        ratingSums[q] += mapRatingToNumber(f[q] || "Neutral");
        ratingCounts[q][f[q] = f[q]||"Neutral"] = (ratingCounts[q][f[q]]||0)+1;
      });

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${f.name||"-"}</td>
        <td>${f.student_id||"-"}</td>
        <td>${f.program||"-"}</td>
        <td>
          Q4:${f.q4||"-"} | Q7:${f.q7||"-"} | Q8:${f.q8||"-"}<br>
          Q10:${f.q10||"-"} | Q13:${f.q13||"-"}
        </td>
        <td>${f.q14||"-"}</td>
        <td class="sentiment-${sentiment.toLowerCase()}">${sentiment}</td>
      `;
      tbody.appendChild(tr);
    });

    // Summary
    document.getElementById("avg-usability").textContent = (ratingSums.q4/feedbackData.length).toFixed(2);
    document.getElementById("avg-relevance").textContent = (ratingSums.q7/feedbackData.length).toFixed(2);
    document.getElementById("avg-accuracy").textContent = (ratingSums.q8/feedbackData.length).toFixed(2);
    document.getElementById("avg-helpfulness").textContent = (ratingSums.q10/feedbackData.length).toFixed(2);
    document.getElementById("avg-satisfaction").textContent = (ratingSums.q13/feedbackData.length).toFixed(2);

    // Ratings Chart (stacked bar)
    const ctxRatings = document.getElementById("ratingsChart");
    new Chart(ctxRatings,{
      type:"bar",
      data:{
        labels:["Q4: Usability","Q7: Relevance","Q8: Accuracy","Q10: Helpfulness","Q13: Satisfaction"],
        datasets:[
          {label:"Very low", data:[ratingCounts.q4["Very difficult"]||0,ratingCounts.q7["Very irrelevant"]||0,ratingCounts.q8["Very inaccurate"]||0,ratingCounts.q10["Very unhelpful"]||0,ratingCounts.q13["Very dissatisfied"]||0], backgroundColor:"#dc2626"},
          {label:"Low", data:[ratingCounts.q4["Difficult"]||0,ratingCounts.q7["Irrelevant"]||0,ratingCounts.q8["Inaccurate"]||0,ratingCounts.q10["Not helpful"]||0,ratingCounts.q13["Dissatisfied"]||0], backgroundColor:"#f97316"},
          {label:"Neutral", data:[ratingCounts.q4["Neutral"]||0,ratingCounts.q7["Neutral"]||0,ratingCounts.q8["Neutral"]||0,ratingCounts.q10["Neutral"]||0,ratingCounts.q13["Neutral"]||0], backgroundColor:"#facc15"},
          {label:"High", data:[ratingCounts.q4["Easy"]||0,ratingCounts.q7["Relevant"]||0,ratingCounts.q8["Accurate"]||0,ratingCounts.q10["Helpful"]||0,ratingCounts.q13["Satisfied"]||0], backgroundColor:"#4ade80"},
          {label:"Very high", data:[ratingCounts.q4["Very easy"]||0,ratingCounts.q7["Very relevant"]||0,ratingCounts.q8["Very accurate"]||0,ratingCounts.q10["Very helpful"]||0,ratingCounts.q13["Very satisfied"]||0], backgroundColor:"#16a34a"}
        ]
      },
      options:{ responsive:true, plugins:{legend:{position:'top'}} }
    });

    // Sentiment Chart
    const ctxSentiment = document.getElementById("sentimentChart");
    new Chart(ctxSentiment,{
      type:"pie",
      data:{
        labels:["Positive","Neutral","Negative"],
        datasets:[{data:[sentimentCount.Positive,sentimentCount.Neutral,sentimentCount.Negative], backgroundColor:["#16a34a","#444","#dc2626"]}]
      }
    });

    // Word frequency
    const text = feedbackData.map(f=>f.q14||"").join(" ").toLowerCase();
    const words = text.replace(/[^a-zA-Z0-9\s]/g,"").split(/\s+/);
    const stopWords = ["the","is","and","to","of","a","in","for","that","with","this","it","on","was","are","but","not","you"];
    const counts = {};
    words.forEach(w=>{ if(!stopWords.includes(w)&&w.length>3) counts[w]=(counts[w]||0)+1; });
    const sorted = Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,15);
    document.getElementById("word-frequency").innerHTML = sorted.map(w=>`<span title="${w[1]} occurrences">${w[0]} (${w[1]})</span>`).join(" ");

  } catch(err){ console.error("Failed to load feedback",err);}
}

// Utility functions
function mapRatingToNumber(r){
  const map = {"Very difficult":1,"Difficult":2,"Neutral":3,"Easy":4,"Very easy":5,"Very irrelevant":1,"Irrelevant":2,"Neutral":3,"Relevant":4,"Very relevant":5,"Very inaccurate":1,"Inaccurate":2,"Accurate":3,"Very accurate":4,"Not helpful":2,"Helpful":4,"Very helpful":5,"Very dissatisfied":1,"Dissatisfied":2,"Neutral":3,"Satisfied":4,"Very satisfied":5};
  return map[r]||3;
}

function classifySentiment(text){
  text = text.toLowerCase();
  if(/(good|helpful|excellent|great|satisfied|positive)/.test(text)) return "Positive";
  if(/(bad|poor|confusing|difficult|unsatisfied|negative)/.test(text)) return "Negative";
  return "Neutral";
}

function exportCSV(){
  if(!feedbackData.length) return alert("No feedback to export.");
  const rows = [["Name","Student ID","Program","Q4","Q5","Q6","Q7","Q8","Q9","Q10","Q11","Q12","Q13","Comments"]];
  feedbackData.forEach(f=>rows.push([f.name,f.student_id,f.program,f.q4,f.q5,f.q6,f.q7,f.q8,f.q9,f.q10,f.q11,f.q12,f.q13,f.q14]));
  const csv = rows.map(r=>r.map(v=>`"${(v||"").toString().replace(/"/g,'""')}"`).join(",")).join("\n");
  const blob = new Blob([csv],{type:"text/csv"});
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "feedback_report.csv";
  link.click();
}

// Search filter
document.getElementById("search").addEventListener("input", e=>{
  const term = e.target.value.toLowerCase();
  const tbody = document.querySelector("#feedback-table tbody");
  Array.from(tbody.rows).forEach(row=>{
    const text = row.textContent.toLowerCase();
    row.style.display = text.includes(term) ? "" : "none";
  });
});

loadFeedback();
setInterval(loadFeedback,10000);
</script>
</body>
</html>
