<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ðŸ“Š Feedback Analysis</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background:#f9f9f9; }
    .container { max-width: 1200px; margin: auto; padding:20px; background:#fff; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.1);}
    h2,h3 { margin-top:25px; }
    table { width:100%; border-collapse:collapse; margin-top:10px;}
    th, td { border:1px solid #ccc; padding:8px; font-size:14px; text-align:left;}
    th { background:#f0f0f0; }
    .sentiment-positive { color:green; font-weight:bold; }
    .sentiment-negative { color:red; font-weight:bold; }
    .sentiment-neutral { color:#444; font-weight:bold; }
    #word-frequency span { display:inline-block; margin:3px; padding:3px 6px; background:#e0f2f1; border-radius:4px; font-size:13px; }
    .btn { padding:8px 16px; border:none; border-radius:6px; background:#16a34a; color:#fff; cursor:pointer; transition:0.2s; }
    .btn:hover { background:#138a3a; }
  </style>
</head>
<body>
<div class="container">
  <h2>Feedback Analysis</h2>
  <p>Total Submissions: <strong id="total-feedback">0</strong></p>
  <p>Average Rating: <strong id="average-rating">0</strong></p>
  <button class="btn" onclick="exportCSV()">Export CSV</button>

  <h3>Ratings Distribution</h3>
  <canvas id="ratingChart" height="80"></canvas>

  <h3>Sentiment Overview</h3>
  <canvas id="sentimentChart" height="80"></canvas>
  <table>
    <thead><tr><th>Sentiment</th><th>Count</th></tr></thead>
    <tbody id="sentiment-table"></tbody>
  </table>

  <h3>Common Words in Feedback</h3>
  <div id="word-frequency"></div>

  <h3>All Feedback</h3>
  <table id="feedback-table">
    <thead>
      <tr>
        <th>#</th><th>Name</th><th>Student ID</th><th>Program</th><th>Q4-Q14 Responses</th><th>Comments</th><th>Sentiment</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
const FEEDBACK_URL = "https://identifyingspiritualsickness-chatbot.onrender.com/export-feedback?key=mc250132689";

async function loadFeedback(){
  try{
    const res = await fetch(FEEDBACK_URL);
    const data = await res.json();
    const feedback = data.feedback || [];
    document.getElementById("total-feedback").textContent = feedback.length;

    let sentimentCount = {Positive:0, Negative:0, Neutral:0};
    let ratingCount = {"Very easy":0,"Easy":0,"Neutral":0,"Difficult":0,"Very difficult":0};
    let ratingSum = 0;
    const tbody = document.querySelector("#feedback-table tbody");
    tbody.innerHTML = "";

    feedback.forEach((f,i)=>{
      const sentimentLabel = "Neutral"; // fallback since sentiment API not in backend
      sentimentCount[sentimentLabel]++;
      ratingCount[f.q4] = (ratingCount[f.q4]||0)+1;
      if(["Very easy","Easy","Neutral","Difficult","Very difficult"].includes(f.q4)) 
          ratingSum += ["Very easy","Easy","Neutral","Difficult","Very difficult"].indexOf(f.q4)+1;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${f.name||"-"}</td>
        <td>${f.student_id||"-"}</td>
        <td>${f.program||"-"}</td>
        <td>
          Q4:${f.q4||"-"} | Q5:${f.q5||"-"} | Q6:${f.q6||"-"}<br>
          Q7:${f.q7||"-"} | Q8:${f.q8||"-"} | Q9:${f.q9||"-"}<br>
          Q10:${f.q10||"-"} | Q11:${f.q11||"-"} | Q12:${f.q12||"-"}<br>
          Q13:${f.q13||"-"}
        </td>
        <td>${f.q14||"-"}</td>
        <td class="sentiment-neutral">Neutral</td>
      `;
      tbody.appendChild(tr);
    });

    document.getElementById("average-rating").textContent = feedback.length ? (ratingSum/feedback.length).toFixed(2) : 0;

    document.getElementById("sentiment-table").innerHTML = `
      <tr><td>Positive</td><td>${sentimentCount.Positive}</td></tr>
      <tr><td>Negative</td><td>${sentimentCount.Negative}</td></tr>
      <tr><td>Neutral</td><td>${sentimentCount.Neutral}</td></tr>
    `;

    new Chart(document.getElementById("ratingChart"),{
      type:"bar",
      data:{
        labels:Object.keys(ratingCount),
        datasets:[{label:"Rating Count", data:Object.values(ratingCount), backgroundColor:"#16a34a"}]
      }
    });

    new Chart(document.getElementById("sentimentChart"),{
      type:"pie",
      data:{
        labels:["Positive","Neutral","Negative"],
        datasets:[{data:[sentimentCount.Positive,sentimentCount.Neutral,sentimentCount.Negative], backgroundColor:["#16a34a","#444","#dc2626"]}]
      }
    });

    const text = feedback.map(f=>f.q14||"").join(" ").toLowerCase();
    const words = text.replace(/[^a-zA-Z0-9\s]/g,"").split(/\s+/);
    const stopWords = ["the","is","and","to","of","a","in","for","that","with","this","it","on","was","are","but","not","you"];
    const counts = {};
    words.forEach(w=>{ if(!stopWords.includes(w)&&w.length>3) counts[w]=(counts[w]||0)+1; });
    const sorted = Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,12);
    document.getElementById("word-frequency").innerHTML = sorted.map(w=>`<span>${w[0]} (${w[1]})</span>`).join(" ");

    window.feedbackData = feedback; 
  } catch(err){ console.error("Failed to load feedback",err);}
}

function exportCSV(){
  if(!window.feedbackData || !window.feedbackData.length) return alert("No feedback to export.");
  const rows = [["Name","Student ID","Program","Q4","Q5","Q6","Q7","Q8","Q9","Q10","Q11","Q12","Q13","Comments"]];
  window.feedbackData.forEach(f=>{
    rows.push([f.name,f.student_id,f.program,f.q4,f.q5,f.q6,f.q7,f.q8,f.q9,f.q10,f.q11,f.q12,f.q13,f.q14]);
  });
  const csv = rows.map(r=>r.map(v=>`"${(v||"").toString().replace(/"/g,'""')}"`).join(",")).join("\n");
  const blob = new Blob([csv],{type:"text/csv"});
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "feedback_report.csv";
  link.click();
}

loadFeedback();
setInterval(loadFeedback,10000);
</script>
</body>
</html>
