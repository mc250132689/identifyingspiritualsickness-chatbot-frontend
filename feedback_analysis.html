<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Feedback Analysis</title>
<link rel="stylesheet" href="style.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #f8f9fa; }
  h2 { text-align: center; margin-bottom: 20px; }
  .chart-container { width: 45%; display: inline-block; margin: 2.5%; vertical-align: top; }
  canvas { background: #fff; border-radius: 10px; padding: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
</style>
</head>
<body>

<h2>Feedback Sentiment & Islamic Emotion Analysis</h2>

<div class="chart-container">
  <canvas id="sentimentChart"></canvas>
</div>
<div class="chart-container">
  <canvas id="islamicEmotionChart"></canvas>
</div>

<div class="chart-container">
  <canvas id="usabilityChart"></canvas>
</div>
<div class="chart-container">
  <canvas id="helpfulnessChart"></canvas>
</div>

<script>
async function fetchFeedbackData() {
    const res = await fetch("/feedback-data");
    const data = await res.json();
    return data;
}

function processFeedback(data) {
    const sentimentCounts = { Positive:0, Neutral:0, Negative:0 };
    const islamicCounts = {};
    const usability = [];
    const helpfulness = [];
    
    data.forEach(fb => {
        // Sentiment
        sentimentCounts[fb.sentiment] = (sentimentCounts[fb.sentiment] || 0) + 1;
        // Islamic emotion
        const ie = fb.islamic_emotion || 'Sakina';
        islamicCounts[ie] = (islamicCounts[ie] || 0) + 1;
        // Usability & Helpfulness ratings
        if(fb.usability) usability.push(fb.usability);
        if(fb.helpfulness) helpfulness.push(fb.helpfulness);
    });

    return { sentimentCounts, islamicCounts, usability, helpfulness };
}

function renderPieChart(ctx, labels, values, title, colors) {
    new Chart(ctx, {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                data: values,
                backgroundColor: colors,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: { display: true, text: title, font: { size: 18 } },
                legend: { position: 'bottom' }
            }
        }
    });
}

function renderBarChart(ctx, labels, values, title, color) {
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: title,
                data: values,
                backgroundColor: color
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false },
                title: { display: true, text: title, font: { size: 16 } }
            },
            scales: { y: { beginAtZero: true, precision:0 } }
        }
    });
}

async function initCharts() {
    const rawData = await fetchFeedbackData();
    const { sentimentCounts, islamicCounts, usability, helpfulness } = processFeedback(rawData);

    // Sentiment Chart
    renderPieChart(
        document.getElementById('sentimentChart'),
        Object.keys(sentimentCounts),
        Object.values(sentimentCounts),
        'Overall Sentiment',
        ['#4caf50','#9e9e9e','#f44336']
    );

    // Islamic Emotion Chart
    renderPieChart(
        document.getElementById('islamicEmotionChart'),
        Object.keys(islamicCounts),
        Object.values(islamicCounts),
        'Islamic Emotions',
        ['#42a5f5','#ffca28','#ab47bc','#ef5350','#26a69a','#ff7043','#8d6e63','#66bb6a','#78909c']
    );

    // Usability & Helpfulness Charts
    renderBarChart(
        document.getElementById('usabilityChart'),
        usability.map((v,i)=>`#${i+1}`),
        usability,
        'Usability Ratings',
        '#42a5f5'
    );

    renderBarChart(
        document.getElementById('helpfulnessChart'),
        helpfulness.map((v,i)=>`#${i+1}`),
        helpfulness,
        'Helpfulness Ratings',
        '#ffa726'
    );
}

initCharts();
</script>

</body>
</html>
