<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Feedback Analysis - Identifying Spiritual Sickness Chatbot</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="stylesheet" href="style.css">
<style>
  h1 { text-align:center; color: var(--primary); margin-bottom: 16px; }
  .container { max-width:900px; margin:0 auto; padding:16px; }
  .stats-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:12px; margin-bottom:24px; }
  .stat-card { background: var(--primary); color:white; padding:16px; border-radius:12px; text-align:center; }
  .feedback-list { max-height:400px; overflow:auto; border-radius:12px; border:1px solid #ccc; padding:12px; background:var(--muted); }
  .feedback-item { padding:8px 12px; border-radius:8px; margin-bottom:8px; }
  .sent-positive { background-color:#d1fae5; border-left:4px solid #10b981; }
  .sent-neutral { background-color:#fef3c7; border-left:4px solid #f59e0b; }
  .sent-negative { background-color:#fee2e2; border-left:4px solid #ef4444; }
  .small { font-size:13px; color:#556; }
  .btn { display:inline-block; padding:10px 14px; border-radius:10px; text-decoration:none; color:white; background:var(--primary); border:none; cursor:pointer; margin-bottom:12px; }
</style>
</head>
<body>
<div class="container">
  <h1>ðŸ“Š Feedback Analysis</h1>
  
  <div class="stats-grid">
    <div class="stat-card">
      <h2 id="total-feedback">0</h2>
      <p>Total Feedback</p>
    </div>
    <div class="stat-card">
      <h2 id="positive-count">0</h2>
      <p>Positive</p>
    </div>
    <div class="stat-card">
      <h2 id="neutral-count">0</h2>
      <p>Neutral</p>
    </div>
    <div class="stat-card">
      <h2 id="negative-count">0</h2>
      <p>Negative</p>
    </div>
  </div>

  <div>
    <h3>Top Keywords</h3>
    <div id="top-keywords" class="small"></div>
  </div>

  <div>
    <h3>Feedback List</h3>
    <div id="feedback-list" class="feedback-list"></div>
  </div>
</div>

<script>
const ADMIN_KEY = prompt("Enter admin key:");
const BASE_URL = "https://identifyingspiritualsickness-chatbot.onrender.com";

async function loadFeedback() {
  if (!ADMIN_KEY) return alert("Admin key required");

  try {
    const res = await fetch(`${BASE_URL}/feedback-analysis?key=${encodeURIComponent(ADMIN_KEY)}`);
    if (!res.ok) throw new Error("Unauthorized or server error");
    const data = await res.json();

    // Stats
    document.getElementById("total-feedback").textContent = data.feedback_count || 0;
    document.getElementById("positive-count").textContent = data.sentiments?.positive || 0;
    document.getElementById("neutral-count").textContent = data.sentiments?.neutral || 0;
    document.getElementById("negative-count").textContent = data.sentiments?.negative || 0;

    // Top keywords
    document.getElementById("top-keywords").textContent = (data.top_keywords || []).join(", ");

    // Feedback list
    const listEl = document.getElementById("feedback-list");
    listEl.innerHTML = "";

    data.feedback_list.slice().reverse().forEach(f => {
      const div = document.createElement("div");
      let sentimentClass = "sent-neutral"; // default
      if (f.sentiment) {
        const s = f.sentiment.toLowerCase();
        if (s === "positive") sentimentClass = "sent-positive";
        if (s === "negative") sentimentClass = "sent-negative";
      }
      div.className = `feedback-item ${sentimentClass}`;
      div.innerHTML = `<strong>${f.name || "Anonymous"} (${f.student_id || "N/A"})</strong><br>${f.comments || f.q12 || f.q14 || ""}`;
      listEl.appendChild(div);
    });

  } catch(err) {
    console.error(err);
    alert("Failed to load feedback. Check admin key or server connection.");
  }
}

// Listen for postMessage refresh
window.addEventListener("message", e => {
  if (e.data?.type === "refresh-feedback") loadFeedback();
});

loadFeedback();
</script>
</body>
</html>
