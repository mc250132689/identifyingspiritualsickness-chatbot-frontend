<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard - Identifying Spiritual Sickness Chatbot</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f0f5f4; padding: 20px; color:#1b3b3a; }
    h1 { text-align: center; color: #14532d; }
    .admin-container { max-width: 900px; margin: 20px auto; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 3px 8px rgba(0,0,0,0.1); }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px; }
    .stat-card { background: #10b981; color: white; padding: 20px; border-radius: 10px; text-align: center; }
    .small { font-size: 13px; color: #064e3b; }

    #login-section { text-align: center; margin-top: 40px; }
    input, button { padding: 10px; margin: 5px; font-size: 16px; }
    button { border: none; border-radius: 8px; cursor: pointer; }

    .btn-row { display: flex; justify-content: center; flex-wrap: wrap; gap: 20px; margin-top: 20px; }
    #train-btn { background: #2563eb; color: white; } #train-btn:hover { background: #1e40af; }
    #view-train-btn { background: #8b5cf6; color: white; } #view-train-btn:hover { background: #6d28d9; }
    #export-data-btn { background:#f59e0b; color:white; } #export-data-btn:hover { background:#b45309; }
    #export-feedback-btn { background:#ef4444; color:white; } #export-feedback-btn:hover { background:#b91c1c; }
    #feedback-analysis-btn { background:#0d9488; color:white; } #feedback-analysis-btn:hover { background:#0f766e; }

    pre { background:#f6f6f9;padding:10px;border-radius:8px; max-height:200px; overflow:auto; }
    .dots span { animation: blink 1s infinite; } .dots span:nth-child(2) { animation-delay: 0.2s; } .dots span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes blink { 0%,20%{opacity:0;} 50%,100%{opacity:1;} }

    #feedback-analysis-container { display: none; margin-top: 30px; background: #f9f9f9; padding: 20px; border-radius: 10px; }
    #feedback-charts { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
    canvas { background: #fff; border-radius: 8px; padding: 10px; }
    @media(max-width:700px){ #feedback-charts { grid-template-columns: 1fr; } }

    #export-pdf-btn { background:#6b7280; color:white; padding:12px 20px; border-radius:8px; cursor:pointer; margin-top:20px; }
    #export-pdf-btn:hover { background:#4b5563; }
  </style>
</head>
<body>
<h1>üîê Admin Dashboard</h1>

<div id="login-section">
  <input type="password" id="admin-key" placeholder="Enter Admin Key">
  <button id="login-btn">Access Dashboard</button>
  <p id="login-status"></p>
</div>

<div id="dashboard" style="display:none">
  <div class="admin-container">
    <div class="stats-grid">
      <div class="stat-card"><h2 id="total-records">0</h2><p>Total Training Records</p></div>
      <div class="stat-card"><h2 id="hadith-count">0</h2><p>Records with Hadith</p></div>
      <div class="stat-card"><h2 id="feedback-count">0</h2><p>Feedback Received</p></div>
    </div>

    <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center">
      <div style="flex:1">
        <h3>Recent Records</h3>
        <div id="recent-list" style="max-height:180px;overflow:auto;padding:8px;background:#f7fff9;border-radius:8px"></div>
      </div>
      <div style="flex:1">
        <h3>Top Questions</h3>
        <div id="top-questions" style="max-height:180px;overflow:auto;padding:8px;background:#fff7ff;border-radius:8px"></div>
      </div>
    </div>

    <div class="btn-row">
      <button id="train-btn" onclick="window.location.href='train.html'">üöÄ Go to Train Bot</button>
      <button id="view-train-btn" onclick="window.location.href='view_training.html'">üìÇ View Training Data</button>
      <button id="export-data-btn">‚¨áÔ∏è Export Training JSON</button>
      <button id="export-feedback-btn">‚¨áÔ∏è Export Feedback (Admin)</button>
      <button id="feedback-analysis-btn">üìä Feedback Analysis</button>
    </div>

    <div style="margin-top:16px">
      <h3>Hadith Examples (up to 5)</h3>
      <div id="hadith-examples"></div>
    </div>

    <div id="feedback-analysis-container">
      <h2>üìä Feedback Analysis</h2>
      <div id="feedback-charts"></div>
      <button id="export-pdf-btn">üìÑ Export PDF Report</button>
    </div>

  </div>
</div>

<script>
const BASE_URL = "https://identifyingspiritualsickness-chatbot.onrender.com";
const loginBtn=document.getElementById("login-btn");
const adminKeyInput=document.getElementById("admin-key");
const loginSection=document.getElementById("login-section");
const dashboard=document.getElementById("dashboard");
const statusText=document.getElementById("login-status");

function animatedDots(text){ return `${text} <span class="dots"><span>.</span><span>.</span><span>.</span></span>`; }

async function checkServerAlive() {
  statusText.innerHTML = animatedDots("‚è≥ Checking server status");
  try{ const res=await fetch(`${BASE_URL}/ping`); if(!res.ok)throw new Error("Server offline"); statusText.textContent="‚úÖ Server is online!"; return true;}
  catch(err){ statusText.innerHTML=animatedDots("‚ö†Ô∏è Server sleeping, waking up"); await new Promise(r=>setTimeout(r,3000)); return checkServerAlive();}
}

async function attemptLogin(){
  const key=adminKeyInput.value.trim(); if(!key)return alert("Please enter admin key");
  await checkServerAlive(); statusText.textContent=animatedDots("‚è≥ Logging in");

  try{
    const res=await fetch(`${BASE_URL}/admin-stats?key=${encodeURIComponent(key)}`);
    const data=await res.json();
    if(data.error) return statusText.textContent="‚ùå Invalid Admin Key";

    loginSection.style.display="none"; dashboard.style.display="block";
    document.getElementById("total-records").textContent=data.total_records;
    document.getElementById("hadith-count").textContent=data.hadith_count;
    document.getElementById("feedback-count").textContent=data.feedback_count;

    const recent=document.getElementById("recent-list"); recent.innerHTML="";
    data.recent_records?.slice().reverse().forEach(r=>{ const d=document.createElement("div"); d.className="small"; d.textContent=`${(r.lang||'en').toUpperCase()} - ${r.question || r.answer}`; recent.appendChild(d); });
    const top=document.getElementById("top-questions"); top.innerHTML="";
    data.top_questions?.forEach(q=>{ const d=document.createElement("div"); d.className="small"; d.textContent=q; top.appendChild(d); });

    const he=document.getElementById("hadith-examples"); he.innerHTML="";
    data.hadith_examples?.forEach(h=>{ const p=document.createElement("pre"); p.textContent=JSON.stringify(h,null,2); he.appendChild(p); });

  }catch(err){ statusText.textContent="‚ö†Ô∏è Error connecting to server."; console.error(err);}
}

loginBtn.addEventListener("click",attemptLogin);
adminKeyInput.addEventListener("keydown",e=>{if(e.key==="Enter") attemptLogin();});

document.getElementById("export-data-btn").addEventListener("click", async()=>{
  const res=await fetch(`${BASE_URL}/export-training-data`);
  const data=await res.json();
  const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
  const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download="training_data_export.json"; a.click(); URL.revokeObjectURL(url);
});

document.getElementById("export-feedback-btn").addEventListener("click", async()=>{
  const key=adminKeyInput.value.trim()||prompt("Enter admin key:"); if(!key) return;
  const res=await fetch(`${BASE_URL}/export-feedback?key=${encodeURIComponent(key)}`);
  const data=await res.json();
  const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
  const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download="feedback_export.json"; a.click(); URL.revokeObjectURL(url);
});

// --- Feedback Analysis with auto color palettes ---
document.getElementById("feedback-analysis-btn").addEventListener("click", async()=>{
  const key=adminKeyInput.value.trim()||prompt("Enter admin key:"); if(!key) return;
  try{
    const res=await fetch(`${BASE_URL}/export-feedback?key=${encodeURIComponent(key)}`);
    const data=await res.json(); const fb=data.feedback||[]; if(fb.length===0){ alert("No feedback data available"); return;}

    const container=document.getElementById("feedback-analysis-container"); container.style.display="block";
    const chartsDiv=document.getElementById("feedback-charts"); chartsDiv.innerHTML="";

    const questions=["q4","q5","q6","q7","q8","q9","q10","q11","q12","q13","q14"];
    const colorPalettes = [
      ['#10b981','#3b82f6','#f97316','#f43f5e','#8b5cf6','#14b8a6','#facc15'],
      ['#2563eb','#f59e0b','#ef4444','#6b7280','#3b82f6','#10b981','#f97316']
    ];

    function calcCounts(field){
      const counts={}; fb.forEach(f=>{ const val=f[field]||"Not answered"; counts[val]=(counts[val]||0)+1; }); return counts;
    }

    questions.forEach((q,qi)=>{
      const canvas=document.createElement("canvas"); canvas.id="chart-"+q; chartsDiv.appendChild(canvas);
      const counts=calcCounts(q); const labels=Object.keys(counts); const values=Object.values(counts);
      const ctx=canvas.getContext('2d');
      const chartType=labels.length<=3?'pie':'bar';

      // assign colors intelligently
      const palette=colorPalettes[qi%colorPalettes.length];
      const bgColors=labels.map((_,i)=>palette[i % palette.length]);

      new Chart(ctx,{
        type: chartType,
        data:{ labels:labels, datasets:[{label:q,data:values,backgroundColor:bgColors}]},
        options:{
          responsive:true,
          plugins:{legend:{display:true,position:'bottom'}},
          scales: chartType==='bar'?{y:{beginAtZero:true}}:{}
        }
      });
    });

  }catch(err){ alert("Failed to load feedback analysis."); console.error(err);}
});

// --- PDF Export ---
document.getElementById("export-pdf-btn").addEventListener("click", async()=>{
  const container=document.getElementById("feedback-analysis-container");
  html2canvas(container,{scale:2}).then(canvas=>{
    const imgData=canvas.toDataURL('image/png');
    const pdf=new jspdf.jsPDF('p','mm','a4');
    const pageWidth=pdf.internal.pageSize.getWidth();
    const imgProps=pdf.getImageProperties(imgData);
    const pdfHeight=(imgProps.height*pageWidth)/imgProps.width;
    pdf.addImage(imgData,'PNG',0,0,pageWidth,pdfHeight);
    pdf.save("feedback_report.pdf");
  });
});
</script>
</body>
</html>
