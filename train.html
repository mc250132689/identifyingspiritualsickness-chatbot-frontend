<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Train Spiritual Bot</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="style.css">
  <style>
    /* --- Button style (same as chat.html) --- */
    .btn {
      padding: 12px 20px;
      font-size: 16px;
      border-radius: 10px;
      transition: background 0.2s;
      text-align: center;
      display: inline-block;
      text-decoration: none;
      cursor: pointer;
      border: none;
      background-color: #4b6960;
      color: white;
      flex-shrink: 0;
    }
    .btn:hover { background-color: #3b5e53; }

    /* --- Form container --- */
    #train-form {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 10px;
    }

    /* --- Input & textarea styles like chat.html --- */
    #train-form input,
    #train-form textarea {
      padding: 12px;
      font-size: 16px;
      border-radius: 10px;
      border: 1px solid #ccc;
      resize: none;
      overflow-y: hidden;
      min-height: 40px;
      max-height: 150px;
      width: 100%;
      box-sizing: border-box;
    }

    /* --- Train preview styling --- */
    #train-preview {
      margin-top: 15px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 12px;
      background: #f9fdfb;
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 300px;
      overflow-y: auto;
    }

    .train-msg-pair { display: flex; flex-direction: column; gap: 4px; }
    .train-user-msg { background: #d1e7dd; padding: 10px; border-radius: 12px; align-self: flex-start; }
    .train-bot-msg { background: #ffffff; border: 1px solid #ccc; padding: 10px; border-radius: 12px; align-self: flex-start; }

    @media (max-width: 600px) {
      .btn { width: 100%; font-size: 16px; padding: 12px 20px; }
      #train-form input, #train-form textarea { font-size: 16px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>Train Chatbot</h1>
      <form id="train-form">
        <input type="text" id="question" placeholder="Enter question" required>
        <textarea id="answer" placeholder="Enter answer" required rows="1"></textarea>
        <button type="submit" class="btn">Submit</button>
      </form>
      <p id="train-response"></p>

      <!-- Preview trained Q&A -->
      <div id="train-preview"></div>
    </div>
  </div>

  <script>
const TRAIN_API_URL = "https://identifyingspiritualsickness-chatbot.onrender.com/train";

const form = document.getElementById("train-form");
const responseText = document.getElementById("train-response");
const preview = document.getElementById("train-preview");

const questionInput = document.getElementById("question");
const answerTextarea = document.getElementById("answer");

// Auto-resize textareas
function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = el.scrollHeight + 'px';
}
[questionInput, answerTextarea].forEach(el => {
  el.addEventListener('input', () => autoResize(el));
  autoResize(el);
});

// Format answer similar to chat.html
function formatAnswer(text) {
  if (!text) return "";
  return text
    .replace(/\r\n|\r|\n/g, "<br>")
    .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
    .replace(/\*(.*?)\*/g, "<em>$1</em>")
    .replace(/\#\#\s(.*?)(\n|$)/g, "<h3>$1</h3>");
}

// Submit training data
form.addEventListener("submit", async (e) => {
  e.preventDefault();

  const question = questionInput.value.trim();
  const answer = answerTextarea.value.trim();

  if (!question || !answer) {
    responseText.textContent = "Please fill both fields.";
    return;
  }

  responseText.textContent = "Submitting...";

  try {
    const res = await fetch(TRAIN_API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ question, answer }),
    });
    const data = await res.json();
    responseText.innerHTML = data.message || "Training data submitted successfully!";

    // Clear inputs
    questionInput.value = "";
    answerTextarea.value = "";
    autoResize(questionInput);
    autoResize(answerTextarea);

    // Show preview
    const userBubble = document.createElement("div");
    userBubble.className = "train-user-msg";
    userBubble.textContent = question;

    const botBubble = document.createElement("div");
    botBubble.className = "train-bot-msg";
    botBubble.innerHTML = formatAnswer(answer);

    const pair = document.createElement("div");
    pair.className = "train-msg-pair";
    pair.appendChild(userBubble);
    pair.appendChild(botBubble);

    preview.appendChild(pair);
    preview.scrollTop = preview.scrollHeight;

    // Update local trained answers cache
    try {
      const cached = JSON.parse(localStorage.getItem('trained_answers_cache') || '[]');
      if (!cached.some(e => e.question.toLowerCase() === question.toLowerCase())) {
        cached.push({ question, answer, lang: 'en' });
        localStorage.setItem('trained_answers_cache', JSON.stringify(cached));
      }
      if (window.chatAddTrainedAnswer) {
        window.chatAddTrainedAnswer(question, answer);
      }
    } catch (err) {
      console.warn(err);
    }

  } catch (err) {
    console.error(err);
    responseText.textContent = "Error submitting training data.";
  }
});
  </script>
</body>
</html>
