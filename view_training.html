<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Training Data Viewer</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>üìù Training Data Viewer</h1>

    <div id="controls">
      <input type="text" id="search-input" placeholder="Search questions or answers...">
      <select id="lang-filter">
        <option value="">All Languages</option>
        <option value="en">English (EN)</option>
        <option value="ms">Malay (MS)</option>
        <option value="ar">Arabic (AR)</option>
      </select>
      <button id="refresh-btn">Refresh Data</button>
      <button id="export-btn">Export Excel</button>
      <button id="import-btn">Import Excel</button>
      <input type="file" id="import-file" style="display:none" accept=".xlsx,.xls">
    </div>

    <div id="training-container"></div>
  </div>

  <script>
    const API_URL = "https://identifyingspiritualsickness-chatbot.onrender.com/get-training-data";
    const TRAIN_API_URL = "https://identifyingspiritualsickness-chatbot.onrender.com/train";

    const container = document.getElementById("training-container");
    const searchInput = document.getElementById("search-input");
    const langFilter = document.getElementById("lang-filter");
    const refreshBtn = document.getElementById("refresh-btn");
    const exportBtn = document.getElementById("export-btn");
    const importBtn = document.getElementById("import-btn");
    const importFile = document.getElementById("import-file");

    let trainingData = [];

    async function loadTrainingData() {
      try {
        const res = await fetch(API_URL);
        const data = await res.json();
        trainingData = data.training_data.reverse();
        displayData(trainingData);
      } catch (err) {
        container.innerHTML = "Error loading data.";
      }
    }

    function displayData(data) {
      container.innerHTML = "";
      if (!data.length) return container.innerHTML = "<p>No training data found.</p>";

      data.forEach(item => {
        const pair = document.createElement("div");
        pair.className = "train-msg-pair";

        const langLabel = document.createElement("div");
        langLabel.className = "train-lang";
        langLabel.textContent = `Language: ${item.lang || "N/A"}`;
        pair.appendChild(langLabel);

        const userMsg = document.createElement("div");
        userMsg.className = "train-user-msg";
        userMsg.textContent = item.question;
        pair.appendChild(userMsg);

        const botMsg = document.createElement("div");
        botMsg.className = "train-bot-msg";
        botMsg.textContent = item.answer;
        pair.appendChild(botMsg);

        container.appendChild(pair);
      });
    }

    function filterAndSearch() {
      let filtered = trainingData;
      const query = searchInput.value.toLowerCase();
      const lang = langFilter.value;
      if (lang) filtered = filtered.filter(item => item.lang === lang);
      if (query) filtered = filtered.filter(item =>
        item.question.toLowerCase().includes(query) || item.answer.toLowerCase().includes(query)
      );
      displayData(filtered);
    }

    searchInput.addEventListener("input", filterAndSearch);
    langFilter.addEventListener("change", filterAndSearch);
    refreshBtn.addEventListener("click", loadTrainingData);

    // Export Excel
    exportBtn.addEventListener("click", () => {
      if (!trainingData.length) return alert("No data to export!");
      const ws = XLSX.utils.json_to_sheet(trainingData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "TrainingData");
      XLSX.writeFile(wb, "training_data.xlsx");
    });

    // Import Excel
    importBtn.addEventListener("click", () => importFile.click());
    importFile.addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = async (evt) => {
        const data = new Uint8Array(evt.target.result);
        const workbook = XLSX.read(data, { type: "array" });
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        const json = XLSX.utils.sheet_to_json(sheet);

        for (let item of json) {
          if (!item.question || !item.answer) continue;
          try {
            await fetch(TRAIN_API_URL, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ question: item.question, answer: item.answer, lang: item.lang || "en" })
            });
          } catch (err) { console.error("Failed to upload:", item, err); }
        }
        await loadTrainingData();
        alert("‚úÖ Import complete!");
      };
      reader.readAsArrayBuffer(file);
    });

    loadTrainingData();
    setInterval(loadTrainingData, 5000);
  </script>
</body>
</html>
