<!DOCTYPE html>
<html>
<head>
  <title>Training Data Viewer</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f8f8f8; }
    h2 { margin-bottom: 10px; }
    input { width: 100%; padding: 10px; margin-bottom: 15px; font-size: 16px; }
    table { width: 100%; border-collapse: collapse; background: white; }
    th, td { padding: 12px; border-bottom: 1px solid #ddd; }
    th { background: #222; color: white; }
    button { padding: 8px 12px; cursor: pointer; border: none; border-radius: 4px; }
    .delete-btn { background: crimson; color: white; }
    .download-btn { background: seagreen; color: white; margin-bottom: 15px; }
  </style>
</head>
<body>

<h2>ðŸ“˜ Training Data Records</h2>

<input type="text" id="searchInput" placeholder="Search questions or answers...">

<button class="download-btn" onclick="downloadCSV()">Download CSV</button>

<table>
  <thead>
    <tr>
      <th>Question</th>
      <th>Answer</th>
      <th>Lang</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody id="dataTable"></tbody>
</table>

<script>
const ADMIN_KEY = "mc250132689"; // your admin key
const API = "https://identifyingspiritualsickness-chatbot.onrender.com";

async function loadData() {
  const res = await fetch(`${API}/get-training-data`);
  const data = await res.json();
  displayData(data.training_data);
}

function displayData(data) {
  const table = document.getElementById("dataTable");
  table.innerHTML = "";

  data.forEach(item => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${item.question}</td>
      <td>${item.answer}</td>
      <td>${item.lang}</td>
      <td><button class="delete-btn" onclick="deleteEntry('${item.question}')">Delete</button></td>
    `;
    table.appendChild(tr);
  });
}

// Live Search Filter
document.getElementById("searchInput").addEventListener("keyup", function () {
  const filter = this.value.toLowerCase();
  const rows = document.querySelectorAll("#dataTable tr");

  rows.forEach(row => {
    row.style.display = row.innerText.toLowerCase().includes(filter) ? "" : "none";
  });
});

// Delete Entry
async function deleteEntry(question) {
  if (!confirm("Delete this entry?")) return;

  await fetch(`${API}/delete-entry?question=${encodeURIComponent(question)}&key=${ADMIN_KEY}`, {
    method: "DELETE",
  });

  loadData();
}

// Download CSV
function downloadCSV() {
  let rows = [["Question", "Answer", "Language"]];
  document.querySelectorAll("#dataTable tr").forEach(tr => {
    let cols = tr.querySelectorAll("td");
    rows.push([cols[0].innerText, cols[1].innerText, cols[2].innerText]);
  });

  let csvContent = rows.map(e => e.join(",")).join("\n");
  let blob = new Blob([csvContent], { type: "text/csv" });

  let link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "training_data.csv";
  link.click();
}

loadData();
</script>

</body>
</html>
