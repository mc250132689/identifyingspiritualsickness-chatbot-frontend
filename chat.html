<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>üïã Identifying Spiritual Sickness Chatbot</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="style.css">
  <style>
    .btn {
      padding: 10px 18px;
      font-size: 14px;
      border-radius: 8px;
      transition: background 0.2s;
      text-align: center;
      display: inline-block;
      text-decoration: none;
    }
    .btn:hover { background-color: #3b5e53; }
    #send-btn { padding: 12px 20px; font-size: 16px; border-radius: 10px; flex-shrink: 0; }
    .input-container { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
    .input-container textarea {
      flex: 1 1 auto;
      padding: 12px;
      font-size: 16px;
      border-radius: 10px;
      resize: none;
      overflow-y: hidden;
      min-height: 40px;
      max-height: 150px;
    }
    header > div:last-child { display: flex; gap: 8px; flex-wrap: wrap; }
    #chat-box {
      margin-top: 10px;
      max-height: 70vh;
      overflow-y: auto;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 12px;
      background: #f9fdfb;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .message { display: inline-block; padding: 10px 14px; margin-bottom: 10px; border-radius: 12px; max-width: 80%; word-wrap: break-word; line-height: 1.4; font-size: 15px; transition: background 0.3s; }
    .message.user { background-color: #d1e7dd; align-self: flex-end; text-align: right; margin-left: auto; }
    .message.bot { background-color: #ffffff; border: 1px solid #ccc; align-self: flex-start; text-align: left; margin-right: auto; }
    .message:last-child { box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    @media (max-width: 600px) {
      header > div:last-child { flex-direction: column; width: 100%; }
      .btn { font-size: 16px; padding: 12px 20px; }
      .input-container textarea { flex: 1 1 100%; }
      #send-btn { width: 100%; }
      #chat-box { max-height: 60vh; }
      .message { font-size: 16px; max-width: 100%; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <header style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
        <div class="brand">Ô∑Ω</div>
        <div style="flex:1">
          <h1>Identifying Spiritual Sickness Chatbot</h1>
          <div style="font-size:13px;color:#4b6960">Answers using Quran, Sahih Hadith & valid ruqyah practices</div>
        </div>
        <div>
          <a class="btn secondary small" href="feedback.html">‚úçÔ∏è Feedback</a>
          <a class="btn small" href="admin_dashboard.html">üîê Admin</a>
        </div>
      </header>

      <div id="chat-box"></div>

      <div class="input-container">
        <textarea id="user-input" placeholder="Type your message... (Enter to send, Shift+Enter for newline)" rows="1"></textarea>
        <button id="send-btn">Send</button>
      </div>
    </div>
  </div>

  <script>
const API_URL = "https://identifyingspiritualsickness-chatbot.onrender.com/chat";
const GUIDANCE_URL = "https://identifyingspiritualsickness-chatbot.onrender.com/guidance";
const TRAIN_DATA_URL = "https://identifyingspiritualsickness-chatbot.onrender.com/get-training-data";

const chatBox = document.getElementById("chat-box");
const input = document.getElementById("user-input");
const sendBtn = document.getElementById("send-btn");

function scrollToBottomSmooth() {
  chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: 'smooth' });
}

function resizeTextarea() {
  input.style.height = 'auto';
  input.style.height = input.scrollHeight + 'px';
  scrollToBottomSmooth();
}
input.addEventListener('input', resizeTextarea);

function normalizeText(s) {
  if (!s) return "";
  return s.toString().toLowerCase().replace(/[^\w\s]/g, ' ').replace(/\s+/g, ' ').trim();
}

let trainedAnswers = {};
async function loadTrainedAnswers() {
  try {
    const res = await fetch(TRAIN_DATA_URL);
    const data = await res.json();
    if (data.training_data && Array.isArray(data.training_data)) {
      trainedAnswers = {};
      data.training_data.forEach(item => {
        trainedAnswers[item.question.toLowerCase()] = item.answer;
      });
      localStorage.setItem('trained_answers_cache', JSON.stringify(data.training_data));
    }
  } catch (err) {
    const cached = localStorage.getItem('trained_answers_cache');
    if (cached) {
      try {
        const arr = JSON.parse(cached);
        trainedAnswers = {};
        arr.forEach(item => trainedAnswers[item.question.toLowerCase()] = item.answer);
      } catch (e) { console.error(e); }
    }
  }
}
loadTrainedAnswers();
setInterval(loadTrainedAnswers, 5000);

function appendMessage(userText, botText) {
  const container = document.createElement("div");
  container.className = "message-pair";

  const userMsg = document.createElement("div");
  userMsg.className = "message user";
  userMsg.innerHTML = userText;
  container.appendChild(userMsg);

  const botMsg = document.createElement("div");
  botMsg.className = "message bot";
  botMsg.innerHTML = botText || "ü§≤ Generating response...";
  container.appendChild(botMsg);

  chatBox.appendChild(container);
  scrollToBottomSmooth();
  return botMsg;
}

function formatBotAnswer(text) {
  if (!text) return "";
  return text
    .replace(/\r\n|\r|\n/g, "<br>")
    .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
    .replace(/\*(.*?)\*/g, "<em>$1</em>")
    .replace(/\#\#\s(.*?)(<br>|$)/g, "<h3>$1</h3>");
}

async function sendMessage() {
  const userText = input.value.trim();
  if (!userText) return;
  input.value = "";
  resizeTextarea();

  const normalizedUser = normalizeText(userText);

  let trainedKey = Object.keys(trainedAnswers).find(k => normalizeText(k) === normalizedUser);
  if (!trainedKey) trainedKey = Object.keys(trainedAnswers).find(k => normalizeText(k).includes(normalizedUser));
  if (trainedKey) {
    appendMessage(`üßç: ${userText}`, `ü§ñ: ${formatBotAnswer(trainedAnswers[trainedKey])}`);
    return;
  }

  const symptomKeywords = ["voices","see","hearing","insomnia","nightmares","dizziness","palpitation","itching","sudden pain","fear","not myself","sudden change","bad luck","family problem","marriage problem"];
  const isSymptom = symptomKeywords.some(k => normalizedUser.includes(k));

  const botMsgElem = appendMessage(`üßç: ${userText}`, null);

  if (isSymptom) {
    try {
      const res = await fetch(GUIDANCE_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ symptoms: userText })
      });
      const data = await res.json();
      let suggestionsHtml = data.suggestions?.map(s => `‚Ä¢ ${s}`).join("<br>") || "";
      let stepsHtml = data.recommended_steps?.length ? "<br><strong>Recommended Steps:</strong><br>" + data.recommended_steps.join("<br>") : "";
      botMsgElem.innerHTML = `ü§ñ: <strong>Severity:</strong> ${data.severity}<br>${suggestionsHtml}${stepsHtml}`;
      scrollToBottomSmooth();
      return;
    } catch (err) {
      botMsgElem.innerHTML = "ü§ñ: Error connecting to backend for guidance.";
      console.error(err);
      return;
    }
  }

  try {
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message: userText })
    });
    const data = await res.json();
    botMsgElem.innerHTML = `ü§ñ: ${formatBotAnswer(data.response)}`;

    try {
      const cached = JSON.parse(localStorage.getItem('trained_answers_cache') || '[]');
      if (!cached.some(e => normalizeText(e.question) === normalizedUser)) {
        cached.push({ question: userText, answer: data.response, lang: 'en' });
        localStorage.setItem('trained_answers_cache', JSON.stringify(cached));
        trainedAnswers[userText.toLowerCase()] = data.response;
      }
    } catch (e) { console.warn(e); }

    scrollToBottomSmooth();
  } catch (err) {
    botMsgElem.innerHTML = "ü§ñ: Error connecting to backend.";
    console.error(err);
    scrollToBottomSmooth();
  }
}

sendBtn.addEventListener('click', sendMessage);
input.addEventListener("keydown", (e) => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

window.addEventListener("message", (event) => {
  if (event.data.type === "refresh-feedback") {
    loadTrainedAnswers();
  }
});
  </script>
</body>
</html>
